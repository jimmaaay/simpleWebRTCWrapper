/** @preserve simpleWebRTCWrapper https://github.com/jimmaaay/simpleWebRTCWrapper */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.SimpleWebRTCWrapper=t()}(this,function(){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var e,l=(function(e){var r=Object.prototype.hasOwnProperty,p="~";function n(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new s(n,r||e,o),i=p?p+t:t;return e._events[i]?e._events[i].fn?e._events[i]=[e._events[i],a]:e._events[i].push(a):(e._events[i]=a,e._eventsCount++),e}function u(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function t(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(p=!1)),t.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)r.call(e,t)&&n.push(p?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},t.prototype.listeners=function(e){var t=p?p+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,o=n.length,a=new Array(o);r<o;r++)a[r]=n[r].fn;return a},t.prototype.listenerCount=function(e){var t=p?p+e:e,n=this._events[t];return n?n.fn?1:n.length:0},t.prototype.emit=function(e,t,n,r,o,a){var i=p?p+e:e;if(!this._events[i])return!1;var s,c,u=this._events[i],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,r),!0;case 5:return u.fn.call(u.context,t,n,r,o),!0;case 6:return u.fn.call(u.context,t,n,r,o,a),!0}for(c=1,s=new Array(l-1);c<l;c++)s[c-1]=arguments[c];u.fn.apply(u.context,s)}else{var f,h=u.length;for(c=0;c<h;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),l){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,n);break;case 4:u[c].fn.call(u[c].context,t,n,r);break;default:if(!s)for(f=1,s=new Array(l-1);f<l;f++)s[f-1]=arguments[f];u[c].fn.apply(u[c].context,s)}}return!0},t.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},t.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},t.prototype.removeListener=function(e,t,n,r){var o=p?p+e:e;if(!this._events[o])return this;if(!t)return u(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||r&&!a.once||n&&a.context!==n||u(this,o);else{for(var i=0,s=[],c=a.length;i<c;i++)(a[i].fn!==t||r&&!a[i].once||n&&a[i].context!==n)&&s.push(a[i]);s.length?this._events[o]=1===s.length?s[0]:s:u(this,o)}return this},t.prototype.removeAllListeners=function(e){var t;return e?(t=p?p+e:e,this._events[t]&&u(this,t)):(this._events=new n,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=p,t.EventEmitter=t,e.exports=t}(e={exports:{}},e.exports),e.exports),y=function(e){var t=JSON.stringify(e);return(new TextEncoder).encode(t).buffer},f=function(e){var t=new Uint8Array(e).buffer,n=new TextDecoder("utf-8"),r=new DataView(t,0,t.byteLength),o=n.decode(r);return JSON.parse(o)},m=function(e,t){return Math.floor(Math.random()*(t-e))+e},h={maxChunkSize:16384,stunServers:["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.services.mozilla.com"],sdpConstraints:{optional:[]}};return function(e){function a(e){var n,t,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),t=this,r=s(a).call(this),(n=!r||"object"!=typeof r&&"function"!=typeof r?u(t):r)._dataChannel=!1,n._connected=!1,n._objectParts={},n.options=Object.assign({},h,e);var o=n.options.stunServers[Math.floor(Math.random()*n.options.stunServers.length)];return n.computer=new RTCPeerConnection({iceServers:[{urls:"stun:"+o}]}),n.computer.ondatachannel=function(e){var t=e.channel;n.dataChannel=t},n._finishCreatingRoom=n._finishCreatingRoom.bind(u(u(n))),n._dataChannelOpen=n._dataChannelOpen.bind(u(u(n))),n._dataChannelMessage=n._dataChannelMessage.bind(u(u(n))),n._dataChannelClose=n._dataChannelClose.bind(u(u(n))),n._dataChannelError=n._dataChannelError.bind(u(u(n))),n}var t,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(a,l),t=a,(n=[{key:"_finishCreatingRoom",value:function(e){var t=JSON.parse(atob(e)),n=new RTCSessionDescription(t);this.computer.setRemoteDescription(n)}},{key:"_dataChannelOpen",value:function(){!1!==this._dataChannel&&(this._connected=!0,this._dataChannel.removeEventListener("open",this._dataChannelOpen),this.emit("connected"))}},{key:"_dataChannelClose",value:function(){this.dataChannel=!1,this.emit("disconnected")}},{key:"_dataChannelError",value:function(e){this.emit("error",e)}},{key:"_dataChannelMessage",value:function(e){var t=new Uint8Array(e.data),n=t[0],r=f(t.slice(1,n+1).buffer),o=t.slice(n+1),a=r.size,i=r.id;if("O"===r.type){if(this._objectParts.hasOwnProperty(r.id)||(this._objectParts[r.id]={total:0,chunks:[]}),this._objectParts[i].total+=o.byteLength,this._objectParts[i].chunks.push(o),this._objectParts[i].total===a){var s=new Uint8Array(a),c=0;this._objectParts[i].chunks.forEach(function(e){s.set(e,c),c+=e.byteLength});var u=f(s.buffer);this.emit("message",u),delete this._objectParts[i]}}else if("F"===r.type){var l=r.name;this.emit("fileChunk",{name:l,id:i,size:a,chunk:o})}}},{key:"createRoom",value:function(){var o=this;return new Promise(function(r,e){o.dataChannel=o.computer.createDataChannel("webrtc"),o.computer.addEventListener("icecandidate",function e(t){if(null==t.candidate){var n=JSON.stringify(o.computer.localDescription.toJSON());o.computer.removeEventListener("icecandidate",e),r({finishCreatingRoom:o._finishCreatingRoom,offer:btoa(n)})}}),o.computer.createOffer().then(function(e){return o.computer.setLocalDescription(e)})})}},{key:"joinRoom",value:function(o){var a=this;return new Promise(function(n,t){var e;try{e=JSON.parse(atob(o))}catch(e){return console.log(e),t(e)}var r=new RTCSessionDescription(e);a.computer.setRemoteDescription(r).then(function(e){return a.computer.createAnswer(a.options.sdpConstraints).then(function(e){return a.computer.setLocalDescription(e)})}),a.computer.addEventListener("icecandidate",function e(t){null==t.candidate&&(a.computer.removeEventListener("icecandidate",e),n(btoa(JSON.stringify(a.computer.localDescription))))})})}},{key:"sendObject",value:function(t){var v=this;return new Promise(function(u,l){if(!1===v._connected)return l(new Error("SimpleWebRTCWrapper: No valid connection"));if("object"!==o(t))return l(new Error("SimpleWebRTCWrapper: No valid object passed to sendObject"));var e="".concat(Math.floor(performance.now()),"__").concat(m(0,9999999999)),f=new Uint8Array(y(t)),h=new Uint8Array(y({id:e,type:"O",size:f.byteLength})),p=h.byteLength,d=v.options.maxChunkSize-p-1;!function e(t,n){var r=d*n,o=t.byteLength-r,a=o<=d?o+p+1:d+p+1,i=o<=d?t.byteLength:r+d,s=new Uint8Array(a),c=t.slice(r,i);return s[0]=p,s.set(h,1),s.set(c,1+p),!1===v.dataChannel?l(new Error("SimpleWebRTCWrapper: No data channel")):(v.dataChannel.send(s),i===f.byteLength?u():void setTimeout(function(){e(t,++n)},0))}(f,0)})}},{key:"sendFile",value:function(t){var p=this;return new Promise(function(s,c){if(!1===p._connected)return c(new Error("SimpleWebRTCWrapper: No valid connection"));if(!(t instanceof File))return c(new Error("SimpleWebRTCWrapper: No valid file passed to sendFile"));var e="".concat(Math.floor(performance.now()),"__").concat(m(0,9999999999)),u=new Uint8Array(y({id:e,type:"F",size:t.size,name:t.name})),l=u.byteLength,f=p.options.maxChunkSize-l-1,h=new FileReader;!function n(r,o){var e=f*o,t=r.size-e,a=t<=f?t+l+1:f+l+1,i=t<=f?r.size:e+f;h.onload=function(){if(!(h.result instanceof ArrayBuffer))return c(new Error("SimpleWebRTCWrapper: issue when reading file"));var e=new Uint8Array(a),t=new Uint8Array(h.result);return e[0]=l,e.set(u,1),e.set(t,1+l),!1===p.dataChannel?c(new Error("SimpleWebRTCWrapper: No data channel")):(p.dataChannel.send(e),i===r.size?s():void setTimeout(function(){n(r,++o)},0))},h.readAsArrayBuffer(r.slice(e,i))}(t,0)})}},{key:"disconnect",value:function(){this._dataChannelClose()}},{key:"dataChannel",get:function(){return this._dataChannel},set:function(e){this._dataChannel=e,!1!==this._dataChannel&&(this._dataChannel.addEventListener("open",this._dataChannelOpen),this._dataChannel.addEventListener("message",this._dataChannelMessage),this._dataChannel.addEventListener("close",this._dataChannelClose),this._dataChannel.addEventListener("error",this._dataChannelError))}}])&&i(t.prototype,n),r&&i(t,r),a}()});
//# sourceMappingURL=simpleWebRTCWrapper.min.js.map
